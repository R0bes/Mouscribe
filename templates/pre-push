#!/bin/bash
# Pre-push hook for Mauscribe
# Runs before git push to perform checks and validations

echo "ğŸ” Pre-push hook triggered - Running checks..."

# Get the current directory (repository root)
REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

# Check if we're on a protected branch
CURRENT_BRANCH=$(git branch --show-current)
PROTECTED_BRANCHES=("main" "master" "develop")

for branch in "${PROTECTED_BRANCHES[@]}"; do
    if [[ "$CURRENT_BRANCH" == "$branch" ]]; then
        echo "âš ï¸  Warning: Pushing to protected branch '$CURRENT_BRANCH'"
        echo "ğŸ’¡ Make sure your changes are reviewed and tested"
        echo ""
    fi
done

# Check if there are uncommitted changes
if ! git diff-index --quiet HEAD --; then
    echo "âš ï¸  Warning: You have uncommitted changes"
    echo "ğŸ’¡ Consider committing or stashing them before pushing"
    echo ""
fi

# Check if tests pass (if test runner exists)
if [ -f "run_tests.py" ]; then
    echo "ğŸ§ª Running tests before push..."
    python run_tests.py
    
    if [ $? -ne 0 ]; then
        echo "âŒ Tests failed! Push aborted."
        echo "ğŸ’¡ Fix the failing tests before pushing"
        exit 1
    else
        echo "âœ… All tests passed!"
    fi
fi

# Check if linting passes (if available)
if [ -f ".pre-commit-config.yaml" ]; then
    echo "ğŸ” Running pre-commit checks..."
    if command -v pre-commit &> /dev/null; then
        pre-commit run --all-files
        
        if [ $? -ne 0 ]; then
            echo "âŒ Pre-commit checks failed! Push aborted."
            echo "ğŸ’¡ Fix the linting issues before pushing"
            exit 1
        else
            echo "âœ… All pre-commit checks passed!"
        fi
    else
        echo "âš ï¸  Pre-commit not installed, skipping linting checks"
    fi
fi

echo "âœ… Pre-push checks completed successfully"
echo "ğŸš€ Ready to push!"
