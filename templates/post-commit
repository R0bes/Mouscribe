#!/bin/bash
# Post-commit hook for Mauscribe pipeline monitoring
# Asks if user wants to push immediately and starts pipeline monitoring

echo "ğŸš€ Post-commit hook triggered!"
echo ""

# Check if we're in a push workflow (have upstream branch)
if git rev-parse --verify origin/$(git branch --show-current) >/dev/null 2>&1; then
    echo "ğŸ“¤ Upstream branch exists - Ready to push"
    echo ""
    echo "ğŸ¤” Soll direkt 'git push' ausgefÃ¼hrt werden? [y/N]"
    read -r response
    
    if [[ "$response" =~ ^[Yy]$ ]]; then
        echo "ğŸš€ Pushing to remote repository..."
        git push
        
        if [ $? -eq 0 ]; then
            echo "âœ… Push erfolgreich! CI/CD Pipeline startet..."
            echo ""
            echo "ğŸ” Starte Pipeline Monitoring..."
            
            # Get the repository root
            REPO_ROOT="$(git rev-parse --show-toplevel)"
            cd "$REPO_ROOT"
            
            # Check if pipeline monitor exists and run it
            if [ -f "pipeline_monitor.py" ]; then
                python pipeline_monitor.py
            else
                echo "âš ï¸  Pipeline monitor nicht gefunden"
                echo "ğŸ’¡ Pipeline lÃ¤uft auf GitHub Actions"
            fi
        else
            echo "âŒ Push fehlgeschlagen"
        fi
    else
        echo "ğŸ’¡ Push Ã¼bersprungen. FÃ¼hre 'git push' manuell aus um Pipeline zu starten."
    fi
else
    echo "ğŸ” No upstream branch - This is likely a local commit"
    echo "ğŸ’¡ Tip: Run 'git push --set-upstream origin $(git branch --show-current)' to set upstream and trigger pipeline"
fi

echo "âœ… Post-commit hook completed"
