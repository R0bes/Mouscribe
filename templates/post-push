#!/bin/bash
# Post-push hook to automatically monitor CI/CD pipelines
# This hook runs after every git push

echo "ğŸš€ Post-push hook triggered - Monitoring CI/CD pipelines..."

# Get the current directory (repository root)
REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

# Get current branch and remote info
CURRENT_BRANCH=$(git branch --show-current)
REMOTE_URL=$(git config --get remote.origin.url)

echo "ğŸ“¤ Pushed branch: $CURRENT_BRANCH"
echo "ğŸŒ Remote: $REMOTE_URL"

# Check if pipeline monitor exists
if [ -f "pipeline_monitor.py" ]; then
    echo "ğŸ” Starting pipeline monitoring..."
    echo ""

    # Use the correct Python command for the platform
    if command -v python3 &> /dev/null; then
        PYTHON_CMD="python3"
    elif command -v python &> /dev/null; then
        PYTHON_CMD="python"
    else
        echo "âŒ Python not found in PATH"
        echo "ğŸ’¡ Pipeline monitoring will be handled by your CI/CD platform"
        PYTHON_CMD=""
    fi

    if [ -n "$PYTHON_CMD" ]; then
        # Run the pipeline monitor
        $PYTHON_CMD pipeline_monitor.py

        # Check the exit code
        if [ $? -eq 0 ]; then
            echo ""
            echo "âœ… Pipeline monitoring completed successfully"
            echo "ğŸ’¡ Your CI/CD pipelines are being monitored"
        else
            echo ""
            echo "âŒ Pipeline monitoring failed or pipelines failed"
            echo "ğŸ’¡ Check the output above for details"
            echo "ğŸ”— Check your CI/CD platform for pipeline status"
        fi
    fi
else
    echo "âš ï¸  Pipeline monitor not found"
    echo "ğŸ’¡ Pipeline monitoring will be handled by your CI/CD platform"

    # Try to detect CI/CD platform and provide helpful info
    if [[ "$REMOTE_URL" == *"github.com"* ]]; then
        echo "ğŸ”— Check GitHub Actions: https://github.com/$(echo $REMOTE_URL | sed 's/.*github.com[:/]\([^/]*\)\/\([^/]*\)\.git.*/\1\/\2/')/actions"
    elif [[ "$REMOTE_URL" == *"gitlab.com"* ]]; then
        echo "ğŸ”— Check GitLab CI: $(echo $REMOTE_URL | sed 's/\.git$//')/-/pipelines"
    elif [[ "$REMOTE_URL" == *"bitbucket.org"* ]]; then
        echo "ğŸ”— Check Bitbucket Pipelines: $(echo $REMOTE_URL | sed 's/\.git$//')/pipelines"
    fi
fi

echo ""
echo "ğŸ Post-push hook completed"
echo "ğŸ‰ Your code is now deployed and being monitored!"
